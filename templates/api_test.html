{% extends 'base.html' %}

{% block title %}API Test Interface - Healthcare Management System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="bi bi-code-square"></i>
            API Test Interface
        </h2>
        <p class="text-muted">Test the Healthcare Management System REST API endpoints</p>
    </div>
</div>

<!-- API Authentication Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-check"></i>
                    Authentication
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="apiToken" class="form-label">JWT Access Token</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="apiToken" placeholder="Your JWT access token">
                                <button class="btn btn-outline-primary" type="button" id="getTokenBtn">
                                    Get Token
                                </button>
                            </div>
                            <div class="form-text">Use your username/password to get a JWT token</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Token Status</label>
                            <div id="tokenStatus" class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                No token provided
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Endpoints Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i>
                    Available Endpoints
                </h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="apiAccordion">
                    
                    <!-- Authentication Endpoints -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#authEndpoints">
                                <i class="bi bi-shield-lock me-2"></i>
                                Authentication APIs
                            </button>
                        </h2>
                        <div id="authEndpoints" class="accordion-collapse collapse show" data-bs-parent="#apiAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <strong>POST</strong> /api/auth/register/
                                            </div>
                                            <div class="card-body">
                                                <p>Register a new user</p>
                                                <button class="btn btn-primary btn-sm test-endpoint" 
                                                        data-method="POST" 
                                                        data-url="/api/auth/register/"
                                                        data-auth="false">
                                                    Test Endpoint
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-success">
                                            <div class="card-header bg-success text-white">
                                                <strong>POST</strong> /api/auth/login/
                                            </div>
                                            <div class="card-body">
                                                <p>Login and get JWT tokens</p>
                                                <button class="btn btn-success btn-sm test-endpoint" 
                                                        data-method="POST" 
                                                        data-url="/api/auth/login/"
                                                        data-auth="false">
                                                    Test Endpoint
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient Endpoints -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#patientEndpoints">
                                <i class="bi bi-people me-2"></i>
                                Patient Management APIs
                            </button>
                        </h2>
                        <div id="patientEndpoints" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-info">
                                            <div class="card-header bg-info text-white">
                                                <strong>GET</strong> /api/patients/
                                            </div>
                                            <div class="card-body">
                                                <p>Get all patients</p>
                                                <button class="btn btn-info btn-sm test-endpoint" 
                                                        data-method="GET" 
                                                        data-url="/api/patients/"
                                                        data-auth="true">
                                                    Test Endpoint
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <strong>POST</strong> /api/patients/
                                            </div>
                                            <div class="card-body">
                                                <p>Create new patient</p>
                                                <button class="btn btn-primary btn-sm test-endpoint" 
                                                        data-method="POST" 
                                                        data-url="/api/patients/"
                                                        data-auth="true">
                                                    Test Endpoint
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Doctor Endpoints -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#doctorEndpoints">
                                <i class="bi bi-person-badge me-2"></i>
                                Doctor Management APIs
                            </button>
                        </h2>
                        <div id="doctorEndpoints" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-info">
                                            <div class="card-header bg-info text-white">
                                                <strong>GET</strong> /api/doctors/
                                            </div>
                                            <div class="card-body">
                                                <p>Get all doctors</p>
                                                <button class="btn btn-info btn-sm test-endpoint" 
                                                        data-method="GET" 
                                                        data-url="/api/doctors/"
                                                        data-auth="true">
                                                    Test Endpoint
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <strong>POST</strong> /api/doctors/
                                            </div>
                                            <div class="card-body">
                                                <p>Create new doctor</p>
                                                <button class="btn btn-primary btn-sm test-endpoint" 
                                                        data-method="POST" 
                                                        data-url="/api/doctors/"
                                                        data-auth="true">
                                                    Test Endpoint
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-terminal"></i>
                    API Response
                </h5>
            </div>
            <div class="card-body">
                <div id="apiResponse" class="bg-dark text-light p-3 rounded" style="min-height: 200px; font-family: monospace;">
                    <div class="text-muted">Click on any "Test Endpoint" button above to see the API response here...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h5>
                    <i class="bi bi-link-45deg"></i>
                    Quick Links
                </h5>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="/api/" class="btn btn-outline-primary">
                        <i class="bi bi-book"></i>
                        Full API Documentation
                    </a>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-success">
                        <i class="bi bi-speedometer2"></i>
                        Dashboard
                    </a>
                    <a href="/admin/" class="btn btn-outline-warning">
                        <i class="bi bi-gear"></i>
                        Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentToken = null;
    
    // Token management
    const tokenInput = document.getElementById('apiToken');
    const tokenStatus = document.getElementById('tokenStatus');
    const getTokenBtn = document.getElementById('getTokenBtn');
    const apiResponse = document.getElementById('apiResponse');
    
    // Update token status
    function updateTokenStatus() {
        if (currentToken) {
            tokenStatus.className = 'alert alert-success';
            tokenStatus.innerHTML = '<i class="bi bi-check-circle"></i> Token is valid and ready to use';
        } else {
            tokenStatus.className = 'alert alert-warning';
            tokenStatus.innerHTML = '<i class="bi bi-exclamation-triangle"></i> No token provided';
        }
    }
    
    // Get token button
    getTokenBtn.addEventListener('click', function() {
        const username = prompt('Enter your username:');
        const password = prompt('Enter your password:');
        
        if (username && password) {
            fetch('/api/auth/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.access) {
                    currentToken = data.access;
                    tokenInput.value = currentToken;
                    updateTokenStatus();
                    showResponse('Token obtained successfully!', data);
                } else {
                    showResponse('Failed to get token', data);
                }
            })
            .catch(error => {
                showResponse('Error getting token', {error: error.message});
            });
        }
    });
    
    // Token input change
    tokenInput.addEventListener('input', function() {
        currentToken = this.value;
        updateTokenStatus();
    });
    
    // Test endpoint buttons
    document.querySelectorAll('.test-endpoint').forEach(button => {
        button.addEventListener('click', function() {
            const method = this.dataset.method;
            const url = this.dataset.url;
            const requiresAuth = this.dataset.auth === 'true';
            
            if (requiresAuth && !currentToken) {
                alert('Please provide a JWT token first');
                return;
            }
            
            const headers = {
                'Content-Type': 'application/json',
            };
            
            if (requiresAuth && currentToken) {
                headers.Authorization = `Bearer ${currentToken}`;
            }
            
            let body = null;
            if (method === 'POST') {
                // Sample data for POST requests
                if (url.includes('patients')) {
                    body = JSON.stringify({
                        first_name: 'John',
                        last_name: 'Doe',
                        email: 'john.doe@example.com',
                        phone_number: '1234567890',
                        date_of_birth: '1990-01-01',
                        gender: 'M',
                        address: '123 Main St',
                        city: 'Anytown',
                        state: 'CA',
                        zip_code: '12345'
                    });
                } else if (url.includes('doctors')) {
                    body = JSON.stringify({
                        first_name: 'Dr. Jane',
                        last_name: 'Smith',
                        email: 'jane.smith@example.com',
                        phone_number: '9876543210',
                        specialization: 'Cardiology',
                        years_of_experience: 10,
                        clinic_name: 'Heart Care Clinic',
                        clinic_address: '456 Oak Ave',
                        clinic_city: 'Medical City',
                        clinic_state: 'CA',
                        clinic_zip_code: '54321'
                    });
                } else if (url.includes('register')) {
                    body = JSON.stringify({
                        username: 'testuser',
                        email: 'test@example.com',
                        password: 'testpassword123'
                    });
                } else if (url.includes('login')) {
                    body = JSON.stringify({
                        username: 'testuser',
                        password: 'testpassword123'
                    });
                }
            }
            
            this.innerHTML = '<span class="loading-spinner"></span> Testing...';
            this.disabled = true;
            
            fetch(url, {
                method: method,
                headers: headers,
                body: body
            })
            .then(response => {
                return response.json().then(data => ({
                    status: response.status,
                    data: data
                }));
            })
            .then(result => {
                showResponse(`${method} ${url} - Status: ${result.status}`, result.data);
                this.innerHTML = 'Test Endpoint';
                this.disabled = false;
            })
            .catch(error => {
                showResponse(`Error testing ${method} ${url}`, {error: error.message});
                this.innerHTML = 'Test Endpoint';
                this.disabled = false;
            });
        });
    });
    
    function showResponse(title, data) {
        const timestamp = new Date().toLocaleTimeString();
        apiResponse.innerHTML = `
            <div class="text-info">[${timestamp}] ${title}</div>
            <pre class="text-light mt-2">${JSON.stringify(data, null, 2)}</pre>
        `;
    }
    
    updateTokenStatus();
});
</script>
{% endblock %}
